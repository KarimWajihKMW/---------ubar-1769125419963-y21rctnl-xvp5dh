<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© - Ø£ÙƒÙˆØ§Ø¯Ø±Ø§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        body.dark-mode { background: #0f172a; color: #e2e8f0; }
        body.dark-mode .bg-white { background: #0b1220 !important; }
        body.dark-mode .bg-gray-50 { background: #111827 !important; }
        body.dark-mode .text-gray-800 { color: #e5e7eb !important; }
        body.dark-mode .text-gray-700 { color: #cbd5e1 !important; }
        body.dark-mode .text-gray-600 { color: #cbd5e1 !important; }
        body.dark-mode .text-gray-500 { color: #94a3b8 !important; }
        body.dark-mode .text-gray-400 { color: #94a3b8 !important; }
        body.dark-mode .border-gray-100 { border-color: #1f2937 !important; }
        body.dark-mode .divide-gray-100 > :not([hidden]) ~ :not([hidden]) { border-color: #1f2937 !important; }
        body.dark-mode .shadow-sm { box-shadow: 0 2px 12px rgba(0, 0, 0, 0.35) !important; }
    </style>
</head>
<body class="bg-gray-50 p-5">
    <div class="max-w-xl mx-auto">
        <button class="flex items-center gap-2 bg-white text-gray-600 px-4 py-2 rounded-lg shadow-sm border border-gray-100 mb-6 hover:bg-gray-50 transition-colors" onclick="goBack()">
            <i class="fas fa-arrow-right"></i>
            Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>
        
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">ğŸ’¬ Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</h1>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ« ØªØ°ÙƒØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h2>
            <p class="text-gray-500 text-sm mb-4">Ø£Ù†Ø´Ø¦ ØªØ°ÙƒØ±Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø±Ø­Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ÙˆØªØ§Ø¨Ø¹ Ø­Ø§Ù„ØªÙ‡Ø§.</p>

            <form id="ticket-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ø±Ø­Ù„Ø© (trip_id) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
                    <input id="ticket-trip-id" type="text" placeholder="Ù…Ø«Ø§Ù„: TR-..." class="w-full px-4 py-3 rounded-2xl border border-gray-200 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500/40" />
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
                    <select id="ticket-category" class="w-full px-4 py-3 rounded-2xl border border-gray-200 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
                        <option value="delay">ØªØ£Ø®ÙŠØ±/Ø§Ù†ØªØ¸Ø§Ø±</option>
                        <option value="cancellation">Ø¥Ù„ØºØ§Ø¡</option>
                        <option value="payment">Ø¯ÙØ¹/Ù…Ø­ÙØ¸Ø©</option>
                        <option value="pricing">Ø³Ø¹Ø±/ØªØ³Ø¹ÙŠØ±</option>
                        <option value="safety">Ø£Ù…Ø§Ù†</option>
                        <option value="other">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ÙˆØµÙ</label>
                    <textarea id="ticket-description" rows="4" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ù…Ø®ØªØµØ±..." class="w-full px-4 py-3 rounded-2xl border border-gray-200 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500/40"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Ù…Ø±ÙÙ‚ (ØµÙˆØ±Ø©/PDF) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
                    <input id="ticket-attachment" type="file" accept="image/*,.pdf" class="w-full" />
                </div>

                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-extrabold py-3 rounded-2xl transition-colors">
                    Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø©
                </button>

                <div id="ticket-form-msg" class="text-sm font-bold text-gray-600 hidden"></div>
            </form>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Œ ØªØ°Ø§ÙƒØ±ÙŠ</h2>
            <div id="tickets-loading" class="text-gray-500 text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            <div id="tickets-empty" class="text-gray-500 text-sm hidden">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
            <div id="tickets-list" class="space-y-3"></div>
        </div>
        
        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Ø·Ø±Ù‚ Ø§Ù„ØªÙˆØ§ØµÙ„</h2>
            
            <div class="space-y-3">
                <a class="flex items-center p-4 rounded-2xl hover:bg-gray-50 transition-colors" href="tel:920000123" aria-label="Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù‡Ø§ØªÙÙŠ">
                    <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 ml-4 shrink-0">
                        <i class="fas fa-phone"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù‡Ø§ØªÙÙŠ</h3>
                        <p class="text-gray-500 text-sm">920000123 - Ù…ØªØ§Ø­ 24/7</p>
                    </div>
                </a>
                
                <a class="flex items-center p-4 rounded-2xl hover:bg-gray-50 transition-colors" href="https://wa.me/966920000123" target="_blank" rel="noopener" aria-label="Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…">
                    <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 ml-4 shrink-0">
                        <i class="fas fa-comment"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800">Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</h3>
                        <p class="text-gray-500 text-sm">Ø§ØªØ­Ø¯Ø« Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¢Ù†</p>
                    </div>
                </a>
                
                <a class="flex items-center p-4 rounded-2xl hover:bg-gray-50 transition-colors" href="mailto:support@akwadra.sa" aria-label="Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¯Ø¹Ù…">
                    <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 ml-4 shrink-0">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h3>
                        <p class="text-gray-500 text-sm">support@akwadra.sa</p>
                    </div>
                </a>
                
                <a class="flex items-center p-4 rounded-2xl hover:bg-gray-50 transition-colors" id="nearby-branches-link" href="egypt-map.html?returnTo=support.html" aria-label="Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©">
                    <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 ml-4 shrink-0">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800">Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©</h3>
                        <p class="text-gray-500 text-sm">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹</p>
                    </div>
                </a>
            </div>
        </div>
        
        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</h2>
            
            <div class="faq-item bg-gray-50 p-4 rounded-2xl mb-3 cursor-pointer hover:bg-gray-100 transition-colors" onclick="toggleFAQ(this)">
                <div class="faq-question font-bold text-gray-800 flex items-center gap-2">
                    <span>â“</span>
                    ÙƒÙŠÙ Ø£Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„ ÙƒØ³Ø§Ø¦Ù‚ØŸ
                </div>
                <div class="faq-answer text-gray-500 text-sm mt-2 hidden">
                    ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø®Ø·ÙˆØ§Øª Ø³Ù‡Ù„Ø©. Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØµÙˆØ±Ø© Ù…Ù† Ø¨Ø·Ø§Ù‚ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ±Ø®ØµØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©. Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø³ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.
                </div>
            </div>
            
            <div class="faq-item bg-gray-50 p-4 rounded-2xl mb-3 cursor-pointer hover:bg-gray-100 transition-colors" onclick="toggleFAQ(this)">
                <div class="faq-question font-bold text-gray-800 flex items-center gap-2">
                    <span>â“</span>
                    Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø¹Ù…ÙˆÙ„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ØŸ
                </div>
                <div class="faq-answer text-gray-500 text-sm mt-2 hidden">
                    Ù†Ø¹Ù…ØŒ Ù‡Ù†Ø§Ùƒ Ø¹Ù…ÙˆÙ„Ø© Ø¨Ù†Ø³Ø¨Ø© 20% Ù…Ù† Ù‚ÙŠÙ…Ø© ÙƒÙ„ Ø±Ø­Ù„Ø©. Ø§Ù„Ø¨Ø§Ù‚ÙŠ ÙŠØ°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø­Ø¨Ù‡ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.
                </div>
            </div>
            
            <div class="faq-item bg-gray-50 p-4 rounded-2xl mb-3 cursor-pointer hover:bg-gray-100 transition-colors" onclick="toggleFAQ(this)">
                <div class="faq-question font-bold text-gray-800 flex items-center gap-2">
                    <span>â“</span>
                    ÙƒÙŠÙ ÙŠØªÙ… Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø³Ø­Ø¨ØŸ
                </div>
                <div class="faq-answer text-gray-500 text-sm mt-2 hidden">
                    ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø³Ø­Ø¨ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¨Ù†ÙƒÙŠ Ø£Ùˆ Ù…Ø­ÙØ¸ØªÙƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©. Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³ÙˆÙ… Ø¹Ù„Ù‰ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø­Ø¨. ØªØªÙ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„.
                </div>
            </div>
            
            <div class="faq-item bg-gray-50 p-4 rounded-2xl cursor-pointer hover:bg-gray-100 transition-colors" onclick="toggleFAQ(this)">
                <div class="faq-question font-bold text-gray-800 flex items-center gap-2">
                    <span>â“</span>
                    Ù…Ø§Ø°Ø§ Ø¥Ø°Ø§ Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ù…Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨ØŸ
                </div>
                <div class="faq-answer text-gray-500 text-sm mt-2 hidden">
                    ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù… Ø³ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø®Ù„Ø§Ù„ Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„ØªØ­Ù‚ÙŠÙ‚.
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function toggleFAQ(element) {
            const answer = element.querySelector('.faq-answer');
            if (!answer) return;
            answer.classList.toggle('hidden');
        }

        function getReturnTo() {
            const params = new URLSearchParams(window.location.search);
            return params.get('returnTo');
        }

        function setupReturnLinks() {
            const returnTo = getReturnTo();
            const branchesLink = document.getElementById('nearby-branches-link');

            if (branchesLink && returnTo) {
                const encoded = encodeURIComponent(returnTo);
                branchesLink.href = `egypt-map.html?returnTo=${encoded}`;
            }
        }

        function goBack() {
            const returnTo = getReturnTo();
            if (returnTo) {
                window.location.href = returnTo;
                return;
            }

            if (document.referrer) {
                try {
                    const referrerUrl = new URL(document.referrer);
                    if (referrerUrl.origin === window.location.origin) {
                        window.history.back();
                        return;
                    }
                } catch (error) {
                    // Ignore invalid referrer
                }
            }

            window.location.href = 'index.html';
        }

        window.addEventListener('DOMContentLoaded', setupReturnLinks);
    </script>

    <script src="api-service.js"></script>
    <script>
        function setMsg(text, isError = false) {
            const el = document.getElementById('ticket-form-msg');
            if (!el) return;
            el.textContent = text || '';
            el.classList.remove('hidden');
            el.classList.toggle('text-red-600', !!isError);
            el.classList.toggle('text-gray-600', !isError);
        }

        function formatDate(d) {
            try {
                return new Date(d).toLocaleString('ar-EG');
            } catch (e) {
                return d;
            }
        }

        function renderTickets(tickets) {
            const list = document.getElementById('tickets-list');
            const empty = document.getElementById('tickets-empty');
            const loading = document.getElementById('tickets-loading');
            if (loading) loading.classList.add('hidden');
            if (!list || !empty) return;

            const rows = Array.isArray(tickets) ? tickets : [];
            if (!rows.length) {
                empty.classList.remove('hidden');
                list.innerHTML = '';
                return;
            }
            empty.classList.add('hidden');

            list.innerHTML = rows.map((t) => {
                const trip = t.trip_id ? `Ø±Ø­Ù„Ø©: ${t.trip_id}` : 'Ø¨Ø¯ÙˆÙ† Ø±Ø­Ù„Ø©';
                const status = (t.status || 'open').toString();
                const attach = t.attachment_path ? `<a class="text-indigo-600 font-bold text-sm" href="${t.attachment_path}" target="_blank" rel="noopener">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚</a>` : '';
                return `
                    <div class="bg-gray-50 border border-gray-100 rounded-2xl p-4">
                        <div class="flex items-center justify-between">
                            <div class="font-extrabold text-gray-800">${(t.category || 'ticket').toString()}</div>
                            <div class="text-xs font-extrabold px-3 py-1 rounded-full bg-white border border-gray-200 text-gray-700">${status}</div>
                        </div>
                        <div class="text-gray-500 text-sm font-bold mt-1">${trip} â€¢ ${formatDate(t.created_at)}</div>
                        ${t.description ? `<div class="text-gray-700 text-sm mt-2">${(t.description || '').toString()}</div>` : ''}
                        ${attach ? `<div class="mt-2">${attach}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function loadTickets() {
            const loading = document.getElementById('tickets-loading');
            if (loading) loading.classList.remove('hidden');
            try {
                const resp = await ApiService.support.listMine();
                renderTickets(resp?.data || []);
            } catch (e) {
                renderTickets([]);
            }
        }

        async function setupTickets() {
            await loadTickets();

            const form = document.getElementById('ticket-form');
            if (!form) return;
            form.addEventListener('submit', async (evt) => {
                evt.preventDefault();
                setMsg('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
                try {
                    const tripId = document.getElementById('ticket-trip-id')?.value?.trim();
                    const category = document.getElementById('ticket-category')?.value;
                    const description = document.getElementById('ticket-description')?.value?.trim();
                    const file = document.getElementById('ticket-attachment')?.files?.[0] || null;

                    const fd = new FormData();
                    if (tripId) fd.append('trip_id', tripId);
                    fd.append('category', category || 'other');
                    if (description) fd.append('description', description);
                    if (file) fd.append('attachment', file);

                    await ApiService.support.createTicket(fd);
                    setMsg('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    form.reset();
                    await loadTickets();
                } catch (e) {
                    setMsg(`âŒ ${e.message || 'ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø©'}`, true);
                }
            });
        }

        window.addEventListener('DOMContentLoaded', setupTickets);
    </script>
    <script>
        (function() {
            try {
                if (localStorage.getItem('akwadra_dark_mode') === '1') {
                    document.body.classList.add('dark-mode');
                }
            } catch (e) {
                // ignore
            }
        })();
    </script>
</body>
</html>
