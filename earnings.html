<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ - Ø£ÙƒÙˆØ§Ø¯Ø±Ø§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }

        body.dark-mode {
            background: #0f172a !important;
            color: #e2e8f0 !important;
        }

        body.dark-mode .bg-white {
            background: #0b1220 !important;
        }

        body.dark-mode .bg-gray-50 {
            background: #111827 !important;
        }

        body.dark-mode .text-gray-800 {
            color: #e5e7eb !important;
        }

        body.dark-mode .text-gray-700 {
            color: #cbd5e1 !important;
        }

        body.dark-mode .text-gray-600 {
            color: #cbd5e1 !important;
        }

        body.dark-mode .text-gray-500 {
            color: #94a3b8 !important;
        }

        body.dark-mode .text-gray-400 {
            color: #94a3b8 !important;
        }

        body.dark-mode .border-gray-100 {
            border-color: #1f2937 !important;
        }

        body.dark-mode .divide-gray-100 > :not([hidden]) ~ :not([hidden]) {
            border-color: #1f2937 !important;
        }

        body.dark-mode .shadow-sm {
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.35) !important;
        }
    </style>
</head>
<body class="bg-gray-50 p-5">
    <div class="max-w-6xl mx-auto">
        <button class="flex items-center gap-2 bg-white text-gray-600 px-4 py-2 rounded-lg shadow-sm border border-gray-100 mb-6 hover:bg-gray-50 transition-colors" onclick="history.back()">
            <i class="fas fa-arrow-right"></i>
            Ø±Ø¬ÙˆØ¹
        </button>

        <div class="mb-8 text-center">
            <div class="w-24 h-24 rounded-full bg-white border border-gray-100 shadow-sm flex items-center justify-center text-5xl mx-auto mb-4 text-gray-700 relative">
                ğŸ’°
                <div class="absolute bottom-0 right-0 bg-green-500 w-6 h-6 rounded-full border-4 border-white"></div>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-1">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h1>
            <p class="text-gray-500">Ù…Ù„Ø®Øµ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <!-- Stats -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:bg-gray-50 transition-colors">
                <div class="text-3xl mb-3">ğŸ’µ</div>
                <div class="font-bold text-green-600 text-xl" dir="ltr" id="balance-value">0 SAR</div>
                <div class="text-gray-500 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯</div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:bg-gray-50 transition-colors">
                <div class="text-3xl mb-3">ğŸš–</div>
                <div class="font-bold text-gray-800 text-xl" id="total-trips-value">0</div>
                <div class="text-gray-500 text-sm">Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:bg-gray-50 transition-colors">
                <div class="text-3xl mb-3">ğŸ“…</div>
                <div class="font-bold text-gray-800 info-value text-xl" id="today-trips-value">0</div>
                <div class="text-gray-500 text-sm">Ø±Ø­Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:bg-gray-50 transition-colors">
                <div class="text-3xl mb-3">ğŸ’°</div>
                <div class="font-bold text-gray-800 info-value text-xl" dir="ltr" id="today-earnings-value">0 SAR</div>
                <div class="text-gray-500 text-sm">Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 mb-8">
            <div class="flex items-center justify-between border-b border-gray-100 pb-4 mb-4">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-history text-indigo-500"></i>
                    Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ùˆ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­
                </h2>
                <span class="text-sm text-gray-500">Ø¢Ø®Ø± 10 Ø±Ø­Ù„Ø§Øª</span>
            </div>
            
            <div class="divide-y divide-gray-100" id="trips-container">
                <!-- Trips will be dynamically loaded here -->
                <div class="py-8 text-center text-gray-400">
                    <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:bg-gray-50 transition-colors cursor-pointer" onclick="alert('Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ù‚Ø±ÙŠØ¨Ø§Ù‹')">
                <div class="text-3xl mb-3">ğŸ¦</div>
                <div class="font-bold text-gray-800">Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯</div>
                <div class="text-gray-500 text-sm">ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ</div>
            </div>
            
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:bg-gray-50 transition-colors cursor-pointer" onclick="window.location.href='menu.html'">
                <div class="text-3xl mb-3">ğŸ </div>
                <div class="font-bold text-gray-800">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                <div class="text-gray-500 text-sm">Ø§Ù„Ø¹ÙˆØ¯Ø©</div>
            </div>
        </div>

    </div>

    <script>
        (function() {
            try {
                // Check localStorage first
                if (localStorage.getItem('akwadra_dark_mode') === '1') {
                    document.body.classList.add('dark-mode');
                } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    // Fallback to system preference if no manual override
                    // document.body.classList.add('dark-mode'); 
                }
            } catch (e) {
                console.error(e);
            }
        })();
    </script>
</body>
</html>
    
        // Load driver stats and earnings
        async function loadDriverStats() {
            try {
                // Get driver ID from localStorage
                const driverProfile = JSON.parse(localStorage.getItem('akwadra_driver_profile') || '{}');
                const driverId = driverProfile.id;
                
                if (!driverId) {
                    console.error('No driver ID found');
                    document.getElementById('trips-container').innerHTML = `
                        <div class="py-8 text-center text-amber-600">
                            <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                            <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</p>
                            <p class="text-sm mt-2">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</p>
                        </div>
                    `;
                    return;
                }
                
                // Fetch driver stats
                const response = await fetch(`/api/drivers/${driverId}/stats`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load stats');
                }
                
                const { earnings, trips, recent_trips } = data.data;
                
                // Update stats
                document.getElementById('balance-value').textContent = `${earnings.balance.toFixed(2)} SAR`;
                document.getElementById('total-trips-value').textContent = trips.total;
                document.getElementById('today-trips-value').textContent = trips.today;
                document.getElementById('today-earnings-value').textContent = `${earnings.today.toFixed(2)} SAR`;
                
                // Display recent trips
                const tripsContainer = document.getElementById('trips-container');
                if (recent_trips && recent_trips.length > 0) {
                    const colors = ['indigo', 'purple', 'orange', 'blue', 'green', 'pink', 'yellow', 'red'];
                    tripsContainer.innerHTML = recent_trips.map((trip, index) => {
                        const color = colors[index % colors.length];
                        const initials = getInitials(trip.passenger_name || 'Ø±Ø§ÙƒØ¨');
                        const date = formatDate(trip.completed_at);
                        const location = trip.dropoff_location || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        
                        return `
                            <div class="py-4 flex items-center justify-between group cursor-pointer hover:bg-gray-50 transition-colors rounded-lg px-2">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-xl bg-${color}-50 text-${color}-600 flex items-center justify-center text-lg font-bold">
                                        ${initials}
                                    </div>
                                    <div>
                                        <div class="font-bold text-gray-800">${trip.passenger_name || 'Ø±Ø§ÙƒØ¨'}</div>
                                        <div class="text-sm text-gray-500 flex items-center gap-1">
                                            <i class="fas fa-map-marker-alt text-xs"></i>
                                            ${location}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-left">
                                    <div class="font-bold text-green-600 text-lg" dir="ltr">+ ${parseFloat(trip.cost || 0).toFixed(2)}</div>
                                    <div class="text-xs text-gray-400">${date}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    tripsContainer.innerHTML = `
                        <div class="py-8 text-center text-gray-400">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ø¨Ø¹Ø¯</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading driver stats:', error);
                document.getElementById('trips-container').innerHTML = `
                    <div class="py-8 text-center text-red-600">
                        <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                        <p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </div>
                `;
            }
        }
        
        function getInitials(name) {
            const words = name.trim().split(' ');
            if (words.length >= 2) {
                return words[0].charAt(0) + '.' + words[1].charAt(0);
            }
            return name.charAt(0) + '.' + (name.charAt(1) || '');
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffHours < 1) {
                const diffMins = Math.floor(diffMs / (1000 * 60));
                return `Ù…Ù†Ø° ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
            } else if (diffHours < 24) {
                return `Ù…Ù†Ø° ${diffHours} Ø³Ø§Ø¹Ø©`;
            } else if (diffDays === 1) {
                return 'Ø£Ù…Ø³ ' + date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays < 7) {
                return `Ù…Ù†Ø° ${diffDays} Ø£ÙŠØ§Ù…`;
            } else {
                return date.toLocaleDateString('ar-SA');
            }
        }
        
        // Load stats on page load
        document.addEventListener('DOMContentLoaded', loadDriverStats);
    