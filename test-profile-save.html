<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</title>
    <script src="api-service.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            direction: rtl;
            text-align: right;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            direction: ltr;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h1>
    
    <div class="test-section">
        <h2>1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ù‡Ø§ØªÙ</h2>
        <input type="text" id="testPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value="0551234567">
        <input type="text" id="testName" placeholder="Ø§Ù„Ø§Ø³Ù…" value="Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø£Ø­Ù…Ø¯">
        <button onclick="testLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h2>2. Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage</h2>
        <button onclick="showLocalStorage()">Ø¹Ø±Ø¶ localStorage</button>
        <div id="localStorageResult"></div>
    </div>

    <div class="test-section">
        <h2>3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
        <button onclick="loadFromDB()">ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <div id="dbLoadResult"></div>
    </div>

    <div class="test-section">
        <h2>4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…</h2>
        <input type="text" id="newName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" value="Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø£Ø­Ù…Ø¯ (Ù…Ø­Ø¯Ø«)">
        <button onclick="updateName()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…</button>
        <div id="updateResult"></div>
    </div>

    <div class="test-section">
        <h2>5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«</h2>
        <button onclick="verifyUpdate()">Ø§Ù„ØªØ­Ù‚Ù‚</button>
        <div id="verifyResult"></div>
    </div>

    <div class="test-section">
        <h2>6. Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <button onclick="simulateLogout()">Ø®Ø±ÙˆØ¬</button>
        <button onclick="simulateLogin()">Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        <div id="simulateResult"></div>
    </div>

    <script>
        const USER_KEY = 'akwadra_user';
        let currentUserId = null;

        async function testLogin() {
            const phone = document.getElementById('testPhone').value;
            const name = document.getElementById('testName').value;
            const result = document.getElementById('loginResult');

            try {
                result.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
                
                const response = await ApiService.users.login(phone, name);
                
                if (response.success) {
                    currentUserId = response.data.id;
                    localStorage.setItem(USER_KEY, JSON.stringify(response.data));
                    
                    result.innerHTML = `<div class="success">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­</div>
                        <pre>${JSON.stringify(response.data, null, 2)}</pre>`;
                } else {
                    result.innerHTML = `<div class="error">âŒ ${response.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">âŒ ${error.message}</div>`;
            }
        }

        function showLocalStorage() {
            const result = document.getElementById('localStorageResult');
            const userData = localStorage.getItem(USER_KEY);
            
            if (userData) {
                result.innerHTML = `<div class="success">âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ localStorage</div>
                    <pre>${JSON.stringify(JSON.parse(userData), null, 2)}</pre>`;
            } else {
                result.innerHTML = `<div class="error">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage</div>`;
            }
        }

        async function loadFromDB() {
            const result = document.getElementById('dbLoadResult');
            const userData = localStorage.getItem(USER_KEY);
            
            if (!userData) {
                result.innerHTML = `<div class="error">âŒ Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</div>`;
                return;
            }

            const userId = JSON.parse(userData).id;
            
            try {
                result.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
                
                const response = await ApiService.users.getById(userId);
                
                if (response.success) {
                    result.innerHTML = `<div class="success">âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                        <pre>${JSON.stringify(response.data, null, 2)}</pre>`;
                } else {
                    result.innerHTML = `<div class="error">âŒ ${response.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">âŒ ${error.message}</div>`;
            }
        }

        async function updateName() {
            const result = document.getElementById('updateResult');
            const userData = localStorage.getItem(USER_KEY);
            
            if (!userData) {
                result.innerHTML = `<div class="error">âŒ Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</div>`;
                return;
            }

            const userId = JSON.parse(userData).id;
            const newName = document.getElementById('newName').value;
            
            try {
                result.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
                
                const response = await ApiService.users.update(userId, { name: newName });
                
                if (response.success) {
                    // Update localStorage
                    const storedUser = JSON.parse(userData);
                    storedUser.name = response.data.name;
                    localStorage.setItem(USER_KEY, JSON.stringify(storedUser));
                    
                    result.innerHTML = `<div class="success">âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ùˆ localStorage</div>
                        <pre>${JSON.stringify(response.data, null, 2)}</pre>`;
                } else {
                    result.innerHTML = `<div class="error">âŒ ${response.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">âŒ ${error.message}</div>`;
            }
        }

        async function verifyUpdate() {
            const result = document.getElementById('verifyResult');
            const userData = localStorage.getItem(USER_KEY);
            
            if (!userData) {
                result.innerHTML = `<div class="error">âŒ Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</div>`;
                return;
            }

            const userId = JSON.parse(userData).id;
            
            try {
                result.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
                
                const response = await ApiService.users.getById(userId);
                
                if (response.success) {
                    const localName = JSON.parse(userData).name;
                    const dbName = response.data.name;
                    
                    result.innerHTML = `<div class="success">âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                        <p><strong>Ø§Ù„Ø§Ø³Ù… ÙÙŠ localStorage:</strong> ${localName}</p>
                        <p><strong>Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</strong> ${dbName}</p>
                        ${localName === dbName ? 
                            '<p class="success">âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ·Ø§Ø¨Ù‚Ø©!</p>' : 
                            '<p class="error">âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©!</p>'}
                        <pre>${JSON.stringify(response.data, null, 2)}</pre>`;
                } else {
                    result.innerHTML = `<div class="error">âŒ ${response.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">âŒ ${error.message}</div>`;
            }
        }

        function simulateLogout() {
            const result = document.getElementById('simulateResult');
            localStorage.removeItem(USER_KEY);
            result.innerHTML = `<div class="success">âœ… ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬ (ØªÙ… Ø­Ø°Ù localStorage)</div>`;
        }

        async function simulateLogin() {
            const result = document.getElementById('simulateResult');
            const phone = document.getElementById('testPhone').value;
            const name = document.getElementById('testName').value;

            try {
                result.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰...';
                
                // Login again
                const response = await ApiService.users.login(phone, name);
                
                if (response.success) {
                    // Save to localStorage
                    localStorage.setItem(USER_KEY, JSON.stringify(response.data));
                    
                    result.innerHTML = `<div class="success">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</div>
                        <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> ${response.data.name}</p>
                        <p>Ù‡Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø« Ù…ÙˆØ¬ÙˆØ¯ØŸ ${response.data.name.includes('Ù…Ø­Ø¯Ø«') ? '<span class="success">âœ… Ù†Ø¹Ù…</span>' : '<span class="error">âŒ Ù„Ø§</span>'}</p>
                        <pre>${JSON.stringify(response.data, null, 2)}</pre>`;
                } else {
                    result.innerHTML = `<div class="error">âŒ ${response.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">âŒ ${error.message}</div>`;
            }
        }

        // Auto-load localStorage on page load
        window.addEventListener('DOMContentLoaded', () => {
            showLocalStorage();
        });
    </script>
</body>
</html>
