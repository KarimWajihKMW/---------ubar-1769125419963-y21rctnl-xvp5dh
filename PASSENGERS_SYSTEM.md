# نظام إدارة الركاب - Passengers Management System

## نظرة عامة
تم إضافة نظام كامل لإدارة الركاب يتعامل مباشرة مع قاعدة البيانات PostgreSQL.

## المميزات الجديدة

### 1. APIs للركاب (Passengers APIs)

#### الحصول على جميع الركاب
```
GET /api/passengers
Query Parameters:
- search: البحث بالاسم أو رقم الهاتف أو البريد الإلكتروني
- limit: عدد النتائج في الصفحة (افتراضي: 50)
- offset: نقطة البداية (افتراضي: 0)
```

#### الحصول على راكب محدد
```
GET /api/passengers/:id
Returns: بيانات الراكب + إحصائيات الرحلات
```

#### إضافة راكب جديد
```
POST /api/passengers
Body:
{
    "name": "اسم الراكب",
    "phone": "رقم الهاتف",
    "email": "البريد الإلكتروني (اختياري)",
    "password": "كلمة المرور (افتراضي: 12345678)"
}
```

#### تحديث بيانات راكب
```
PUT /api/passengers/:id
Body:
{
    "name": "الاسم الجديد",
    "phone": "رقم الهاتف الجديد",
    "email": "البريد الإلكتروني الجديد",
    "password": "كلمة المرور الجديدة (اختياري)"
}
```

#### حذف راكب
```
DELETE /api/passengers/:id
Note: لا يمكن حذف راكب لديه رحلات نشطة
```

#### الحصول على رحلات راكب
```
GET /api/passengers/:id/trips
Query Parameters:
- status: حالة الرحلة (all, pending, completed, cancelled)
- limit: عدد النتائج
- offset: نقطة البداية
```

### 2. واجهة إدارة الركاب (passengers.html)

واجهة ويب كاملة لإدارة الركاب تتضمن:
- ✅ عرض جميع الركاب في جدول تفاعلي
- ✅ البحث الفوري عن الركاب
- ✅ إضافة راكب جديد
- ✅ تعديل بيانات راكب
- ✅ حذف راكب
- ✅ عرض تفاصيل الراكب وإحصائياته
- ✅ عرض رحلات الراكب
- ✅ إحصائيات شاملة (إجمالي الركاب، الركاب النشطون، إجمالي الرحلات، الإيرادات)
- ✅ نظام ترقيم الصفحات (Pagination)
- ✅ تصميم عصري وسهل الاستخدام

### 3. تحديثات قاعدة البيانات

تم تحديث جدول `users` ليتضمن:
- ✅ عمود `updated_at` لتتبع آخر تحديث
- ✅ فهرس (Index) على عمود `role` لتسريع الاستعلامات
- ✅ جميع الأعمدة الضرورية لإدارة الركاب

### 4. تحديثات API Service

تم إضافة قسم `passengers` في ملف `api-service.js`:
```javascript
ApiService.passengers.getAll(params)
ApiService.passengers.getById(id)
ApiService.passengers.create(data)
ApiService.passengers.update(id, data)
ApiService.passengers.delete(id)
ApiService.passengers.getTrips(id, params)
```

## الملفات الجديدة

1. **passengers.html** - واجهة إدارة الركاب
2. **update-users-table.js** - سكريبت تحديث قاعدة البيانات
3. **test-passengers-api.js** - اختبارات شاملة لـ APIs الركاب
4. **PASSENGERS_SYSTEM.md** - هذا الملف (التوثيق)

## الملفات المعدلة

1. **server.js** - إضافة APIs الركاب
2. **api-service.js** - إضافة دوال التعامل مع APIs الركاب
3. **package.json** - إضافة axios للاختبارات

## كيفية الاستخدام

### 1. تحديث قاعدة البيانات
```bash
node update-users-table.js
```

### 2. تشغيل الخادم
```bash
npm start
```

### 3. فتح واجهة إدارة الركاب
افتح المتصفح على:
```
http://localhost:3000/passengers.html
```

### 4. اختبار APIs
```bash
node test-passengers-api.js
```

## نتائج الاختبار

جميع الاختبارات نجحت ✅:
- ✅ GET /api/passengers - جلب جميع الركاب
- ✅ POST /api/passengers - إضافة راكب جديد
- ✅ GET /api/passengers/:id - جلب راكب محدد
- ✅ PUT /api/passengers/:id - تحديث بيانات راكب
- ✅ GET /api/passengers?search=... - البحث عن ركاب
- ✅ GET /api/passengers/:id/trips - جلب رحلات راكب
- ✅ رفض الهاتف المكرر
- ✅ DELETE /api/passengers/:id - حذف راكب
- ✅ رفض جلب راكب محذوف

## الأمان

- ✅ التحقق من صحة البيانات في جميع APIs
- ✅ منع تسجيل رقم هاتف أو بريد إلكتروني مكرر
- ✅ منع حذف راكب لديه رحلات نشطة
- ✅ تحديث timestamp عند كل تعديل
- ✅ استخدام Parameterized Queries لمنع SQL Injection

## قاعدة البيانات

جميع عمليات الركاب تتم مباشرة على قاعدة البيانات:
- ✅ PostgreSQL على Railway
- ✅ اتصال مباشر وفوري
- ✅ تحديثات في الوقت الفعلي (Real-time)
- ✅ معاملات آمنة (Safe Transactions)

## الإحصائيات المتاحة

لكل راكب:
- إجمالي عدد الرحلات
- عدد الرحلات المكتملة
- عدد الرحلات الملغاة
- إجمالي المبلغ المدفوع

للنظام بالكامل:
- إجمالي عدد الركاب
- عدد الركاب النشطون
- إجمالي عدد الرحلات
- إجمالي الإيرادات

## ملاحظات مهمة

1. جميع التعديلات على الركاب تتم **مباشرة** في قاعدة البيانات
2. النظام يدعم **البحث الفوري** في الوقت الفعلي
3. **لا يمكن** حذف راكب لديه رحلات نشطة (حماية للبيانات)
4. كلمة المرور الافتراضية للركاب الجدد: `12345678`
5. يتم إنشاء بريد إلكتروني تلقائي إذا لم يتم إدخاله

## التطويرات المستقبلية المقترحة

- [ ] إضافة نظام الإشعارات للركاب
- [ ] تصدير بيانات الركاب إلى Excel/CSV
- [ ] رسوم بيانية للإحصائيات
- [ ] نظام نقاط الولاء للركاب
- [ ] سجل التعديلات (Audit Log)

---

تم التطوير والاختبار بنجاح ✅
تاريخ الإنشاء: 5 فبراير 2026
