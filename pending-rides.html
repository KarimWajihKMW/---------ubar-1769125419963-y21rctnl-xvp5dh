<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± - Ø£ÙˆØ¨Ø±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card.waiting .value {
            color: #f59e0b;
        }

        .stat-card.accepted .value {
            color: #10b981;
        }

        .stat-card.rejected .value {
            color: #ef4444;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls select,
        .controls button {
            padding: 12px 24px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .controls select {
            background: white;
            color: #333;
        }

        .controls button {
            background: #667eea;
            color: white;
            border: none;
            font-weight: bold;
        }

        .controls button:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .requests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .request-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .request-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .request-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
        }

        .request-card.waiting::before {
            background: #f59e0b;
        }

        .request-card.accepted::before {
            background: #10b981;
        }

        .request-card.rejected::before,
        .request-card.cancelled::before {
            background: #ef4444;
        }

        .request-card.expired::before {
            background: #6b7280;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }

        .request-id {
            font-weight: bold;
            color: #667eea;
            font-size: 0.9em;
        }

        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-badge.waiting {
            background: #fef3c7;
            color: #d97706;
        }

        .status-badge.accepted {
            background: #d1fae5;
            color: #059669;
        }

        .status-badge.rejected,
        .status-badge.cancelled {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-badge.expired {
            background: #e5e7eb;
            color: #4b5563;
        }

        .passenger-info {
            margin-bottom: 15px;
        }

        .passenger-info h4 {
            color: #333;
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .passenger-info p {
            color: #666;
            font-size: 0.9em;
        }

        .location-info {
            margin-bottom: 20px;
        }

        .location-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 10px;
        }

        .location-icon {
            font-size: 1.5em;
        }

        .location-text {
            flex: 1;
        }

        .location-label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .location-address {
            color: #333;
            font-weight: 500;
        }

        .trip-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
        }

        .detail-item {
            text-align: center;
        }

        .detail-label {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .rejection-info {
            background: #fee2e2;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-right: 4px solid #ef4444;
        }

        .rejection-info p {
            color: #991b1b;
            font-size: 0.9em;
            font-weight: 500;
        }

        .driver-info {
            background: #d1fae5;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-right: 4px solid #10b981;
        }

        .driver-info p {
            color: #065f46;
            font-weight: 500;
            font-size: 0.9em;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
            font-size: 0.85em;
            color: #666;
        }

        .no-requests {
            background: white;
            border-radius: 15px;
            padding: 60px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .no-requests h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .no-requests p {
            color: #666;
            font-size: 1.1em;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: white;
            font-size: 1.5em;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>ğŸš—</span>
                Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
            </h1>
            <p>Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù… ÙŠÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†</p>
        </div>

        <div class="stats">
            <div class="stat-card waiting">
                <h3>ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h3>
                <div class="value" id="waitingCount">0</div>
            </div>
            <div class="stat-card accepted">
                <h3>ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„</h3>
                <div class="value" id="acceptedCount">0</div>
            </div>
            <div class="stat-card rejected">
                <h3>ØªÙ… Ø§Ù„Ø±ÙØ¶</h3>
                <div class="value" id="rejectedCount">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                <div class="value" id="totalCount">0</div>
            </div>
        </div>

        <div class="controls">
            <select id="statusFilter">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                <option value="waiting">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                <option value="accepted">ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„</option>
                <option value="rejected">ØªÙ… Ø§Ù„Ø±ÙØ¶</option>
                <option value="cancelled">ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡</option>
                <option value="expired">Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</option>
            </select>

            <select id="carTypeFilter">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>
                <option value="economy">Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</option>
                <option value="family">Ø¹Ø§Ø¦Ù„ÙŠØ©</option>
                <option value="luxury">ÙØ§Ø®Ø±Ø©</option>
            </select>

            <button onclick="loadRequests()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            <button onclick="cleanupExpired()">ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</button>
        </div>

        <div id="requestsContainer">
            <div class="loading">
                <div class="spinner">â³</div>
                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        async function loadRequests() {
            try {
                const statusFilter = document.getElementById('statusFilter').value;
                const carTypeFilter = document.getElementById('carTypeFilter').value;

                let url = `${API_BASE}/pending-rides?`;
                if (statusFilter) url += `status=${statusFilter}&`;
                if (carTypeFilter) url += `car_type=${carTypeFilter}&`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    displayRequests(data.data);
                    updateStats(data.data);
                }
            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('requestsContainer').innerHTML = `
                    <div class="no-requests">
                        <h2>âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function updateStats(requests) {
            const waiting = requests.filter(r => r.status === 'waiting').length;
            const accepted = requests.filter(r => r.status === 'accepted').length;
            const rejected = requests.filter(r => r.status === 'rejected').length;

            document.getElementById('waitingCount').textContent = waiting;
            document.getElementById('acceptedCount').textContent = accepted;
            document.getElementById('rejectedCount').textContent = rejected;
            document.getElementById('totalCount').textContent = requests.length;
        }

        function displayRequests(requests) {
            const container = document.getElementById('requestsContainer');

            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="no-requests">
                        <h2>ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</h2>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø±Ø­Ù„Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</p>
                    </div>
                `;
                return;
            }

            const html = `
                <div class="requests-grid">
                    ${requests.map(req => createRequestCard(req)).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        function createRequestCard(req) {
            const statusText = {
                waiting: 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                accepted: 'ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„',
                rejected: 'ØªÙ… Ø§Ù„Ø±ÙØ¶',
                cancelled: 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡',
                expired: 'Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©'
            };

            const carTypeText = {
                economy: 'Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©',
                family: 'Ø¹Ø§Ø¦Ù„ÙŠØ©',
                luxury: 'ÙØ§Ø®Ø±Ø©'
            };

            const createdAt = new Date(req.created_at).toLocaleString('ar-SA');
            const expiresAt = req.expires_at ? new Date(req.expires_at).toLocaleString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

            let rejectionHtml = '';
            if (req.rejection_count > 0) {
                rejectionHtml = `
                    <div class="rejection-info">
                        <p>âš ï¸ ØªÙ… Ø§Ù„Ø±ÙØ¶ Ù…Ù† ${req.rejection_count} Ø³Ø§Ø¦Ù‚</p>
                    </div>
                `;
            }

            let driverHtml = '';
            if (req.assigned_driver_name) {
                driverHtml = `
                    <div class="driver-info">
                        <p>âœ… Ø§Ù„Ø³Ø§Ø¦Ù‚: ${req.assigned_driver_name}</p>
                    </div>
                `;
            }

            return `
                <div class="request-card ${req.status}">
                    <div class="request-header">
                        <div class="request-id">${req.request_id}</div>
                        <div class="status-badge ${req.status}">${statusText[req.status] || req.status}</div>
                    </div>

                    <div class="passenger-info">
                        <h4>${req.passenger_name}</h4>
                        <p>ğŸ“± ${req.passenger_phone}</p>
                    </div>

                    <div class="location-info">
                        <div class="location-item">
                            <div class="location-icon">ğŸ“</div>
                            <div class="location-text">
                                <div class="location-label">Ù…Ù†</div>
                                <div class="location-address">${req.pickup_location}</div>
                            </div>
                        </div>
                        <div class="location-item">
                            <div class="location-icon">ğŸ¯</div>
                            <div class="location-text">
                                <div class="location-label">Ø¥Ù„Ù‰</div>
                                <div class="location-address">${req.dropoff_location}</div>
                            </div>
                        </div>
                    </div>

                    <div class="trip-details">
                        <div class="detail-item">
                            <div class="detail-label">Ø§Ù„Ø³Ø¹Ø±</div>
                            <div class="detail-value">${req.estimated_cost} Ø±.Ø³</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ø§Ù„Ù…Ø³Ø§ÙØ©</div>
                            <div class="detail-value">${req.estimated_distance || 'N/A'} ÙƒÙ…</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
                            <div class="detail-value">${carTypeText[req.car_type] || req.car_type}</div>
                        </div>
                    </div>

                    ${rejectionHtml}
                    ${driverHtml}

                    <div class="time-info">
                        <span>ğŸ• ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${createdAt}</span>
                    </div>
                    ${req.status === 'waiting' ? `
                        <div class="time-info" style="border-top: none; padding-top: 5px;">
                            <span>â° ØªÙ†ØªÙ‡ÙŠ ÙÙŠ: ${expiresAt}</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function cleanupExpired() {
            try {
                const response = await fetch(`${API_BASE}/pending-rides/cleanup`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert(`âœ… ${data.message}`);
                    loadRequests();
                }
            } catch (error) {
                console.error('Error cleaning up:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ†Ø¸ÙŠÙ');
            }
        }

        // Event listeners
        document.getElementById('statusFilter').addEventListener('change', loadRequests);
        document.getElementById('carTypeFilter').addEventListener('change', loadRequests);

        // Auto-refresh every 30 seconds
        setInterval(loadRequests, 30000);

        // Initial load
        loadRequests();
    </script>
</body>
</html>
