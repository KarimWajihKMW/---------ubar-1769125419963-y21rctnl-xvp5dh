# ูุธุงู ุฃุฑุจุงุญ ุงูุณุงุฆููู - Driver Earnings System

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุชูููุฐ ูุธุงู ุดุงูู ูุชุชุจุน ูุฅุฏุงุฑุฉ ุฃุฑุจุงุญ ุงูุณุงุฆููู ูู ุงูุชุทุจูู. ุงููุธุงู ูุณุชุฎุฏู ุฌุฏูููู ุฑุฆูุณููู ูุชุฎุฒูู ุงูุจูุงูุงุช ูุชูููุฑ ูุนูููุงุช ุฏูููุฉ ูู ุงูููุช ุงููุนูู.

---

## ๐ ุจููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### 1. ุฌุฏูู `drivers`
ูุญุชูู ุนูู ูุนูููุงุช ุงูุณุงุฆู ุงูุฃุณุงุณูุฉ ูุงูุฅุญุตุงุฆูุงุช ุงูุญุงููุฉ:

```sql
TABLE drivers (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20) UNIQUE NOT NULL,
    
    -- ุฃุนูุฏุฉ ุงูุฃุฑุจุงุญ
    today_earnings DECIMAL(10, 2) DEFAULT 0.00,      -- ุฃุฑุจุงุญ ุงูููู  
    today_trips_count INTEGER DEFAULT 0,              -- ุนุฏุฏ ุฑุญูุงุช ุงูููู
    total_earnings DECIMAL(10, 2) DEFAULT 0.00,      -- ุฅุฌูุงูู ุงูุฃุฑุจุงุญ
    total_trips INTEGER DEFAULT 0,                    -- ุฅุฌูุงูู ุงูุฑุญูุงุช
    balance DECIMAL(10, 2) DEFAULT 0.00,             -- ุงูุฑุตูุฏ ุงููุชุงุญ
    last_earnings_update DATE DEFAULT CURRENT_DATE,   -- ุขุฎุฑ ุชุญุฏูุซ
    
    -- ุฃุนูุฏุฉ ุฃุฎุฑู...
)
```

### 2. ุฌุฏูู `driver_earnings`
ุณุฌู ุชุงุฑูุฎู ูููู ูุฃุฑุจุงุญ ูู ุณุงุฆู:

```sql
CREATE TABLE driver_earnings (
    id SERIAL PRIMARY KEY,
    driver_id INTEGER REFERENCES drivers(id) ON DELETE CASCADE,
    date DATE NOT NULL DEFAULT CURRENT_DATE,
    
    today_trips INTEGER DEFAULT 0,                    -- ุฑุญูุงุช ุงูููู
    today_earnings DECIMAL(10, 2) DEFAULT 0.00,      -- ุฃุฑุจุงุญ ุงูููู
    total_trips INTEGER DEFAULT 0,                    -- ุฅุฌูุงูู ุงูุฑุญูุงุช ุญุชู ูุฐุง ุงูุชุงุฑูุฎ
    total_earnings DECIMAL(10, 2) DEFAULT 0.00,      -- ุฅุฌูุงูู ุงูุฃุฑุจุงุญ ุญุชู ูุฐุง ุงูุชุงุฑูุฎ
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(driver_id, date)  -- ุณุฌู ูุงุญุฏ ููู ููู ููู ุณุงุฆู
);

-- Index ูุชุญุณูู ุงูุฃุฏุงุก
CREATE INDEX idx_driver_earnings_driver_date 
ON driver_earnings(driver_id, date DESC);
```

---

## ๐ API Endpoints

### 1. ุงูุญุตูู ุนูู ุฅุญุตุงุฆูุงุช ุงูุณุงุฆู
**Endpoint:** `GET /api/drivers/:id/stats`

**ุงููุตู:** ูุญุตู ุนูู ุงูุฅุญุตุงุฆูุงุช ุงูุญุงููุฉ ููุณุงุฆู ูู ุฌุฏูู `drivers`

**Response:**
```json
{
  "success": true,
  "data": {
    "driver": {
      "id": 1,
      "name": "ุฃุญูุฏ ูุญูุฏ",
      "phone": "0501234567",
      "email": "ahmed@example.com",
      "rating": 4.85
    },
    "earnings": {
      "today": 250.50,        // ุฃุฑุจุงุญ ุงูููู
      "total": 15430.75,      // ุฅุฌูุงูู ุงูุฃุฑุจุงุญ
      "balance": 15430.75     // ุงูุฑุตูุฏ ุงููุชุงุญ
    },
    "trips": {
      "today": 12,            // ุฑุญูุงุช ุงูููู
      "total": 543            // ุฅุฌูุงูู ุงูุฑุญูุงุช
    },
    "recent_trips": [...]
  }
}
```

**ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู:**
```javascript
const response = await fetch('/api/drivers/1/stats');
const data = await response.json();
console.log(`ุฃุฑุจุงุญ ุงูููู: ${data.data.earnings.today} ุฑ.ุณ`);
```

---

### 2. ุงูุญุตูู ุนูู ุณุฌู ุงูุฃุฑุจุงุญ ุงูุชุงุฑูุฎู
**Endpoint:** `GET /api/drivers/:id/earnings?days=30`

**ุงููุตู:** ูุญุตู ุนูู ุงูุณุฌู ุงูุชุงุฑูุฎู ููุฃุฑุจุงุญ ูู ุฌุฏูู `driver_earnings`

**Parameters:**
- `days` (optional): ุนุฏุฏ ุงูุฃูุงู ุงููุทููุจุฉ (ุงูุชุฑุงุถูุงู: 30)

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "date": "2026-02-09",
      "today_trips": 15,
      "today_earnings": 420.50,
      "total_trips": 543,
      "total_earnings": 15430.75,
      "created_at": "2026-02-09T08:00:00.000Z",
      "updated_at": "2026-02-09T18:45:00.000Z"
    },
    {
      "date": "2026-02-08",
      "today_trips": 18,
      "today_earnings": 510.25,
      "total_trips": 528,
      "total_earnings": 15010.25
    }
  ]
}
```

**ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู:**
```javascript
// ุงุญุตู ุนูู ุขุฎุฑ 7 ุฃูุงู
const response = await fetch('/api/drivers/1/earnings?days=7');
const data = await response.json();

// ุนุฑุถ ุงูุจูุงูุงุช
data.data.forEach(day => {
    console.log(`${day.date}: ${day.today_earnings} ุฑ.ุณ (${day.today_trips} ุฑุญูุฉ)`);
});
```

---

## ๐ฅ๏ธ ุตูุญุฉ ุนุฑุถ ุงูุฃุฑุจุงุญ

### ุงูููู: `earnings.html`

ุตูุญุฉ ููุจ ูุชูุงููุฉ ูุนุฑุถ ุฃุฑุจุงุญ ุงูุณุงุฆู ุจุดูู ุชูุงุนูู ูุฌููู.

**ุงููููุฒุงุช:**
- โ ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ูู ุงูููุช ุงููุนูู
- โ ุชุญุฏูุซ ุชููุงุฆู ูู 10 ุซูุงูู
- โ ุนุฑุถ ุขุฎุฑ ุงูุฑุญูุงุช
- โ ุฏุนู ุงููุถุน ุงููููู/ุงูููุงุฑู
- โ ุชุตููู ูุชุฌุงูุจ (mobile-first)
- โ ุฑุณูู ูุชุญุฑูุฉ ุณูุณุฉ

**ููููุฉ ุงูุงุณุชุฎุฏุงู:**
1. ุงูุชุญ ุงูุฑุงุจุท: `http://localhost:3000/earnings.html`
2. ุชุฃูุฏ ูู ุชุณุฌูู ุงูุฏุฎูู ูุณุงุฆู
3. ุณูุชู ุชุญููู ุงูุจูุงูุงุช ุชููุงุฆูุงู ูู localStorage

**ุงูุนูุงุตุฑ ุงููุนุฑูุถุฉ:**
- ๐ต ุฅุฌูุงูู ุงูุฑุตูุฏ
- ๐ ุงูุฑุญูุงุช ุงูููุชููุฉ
- ๐ ุฑุญูุงุช ุงูููู
- ๐ฐ ุฃุฑุจุงุญ ุงูููู
- ๐ ุณุฌู ุขุฎุฑ 10 ุฑุญูุงุช

---

## ๐ ุขููุฉ ุงูุชุญุฏูุซ ุงูุชููุงุฆู

ุงููุธุงู ูุญุฏุซ ุฌุฏูู `driver_earnings` ุชููุงุฆูุงู ุนูุฏ:
1. ุฅููุงู ุฑุญูุฉ ุฌุฏูุฏุฉ
2. ุชุบููุฑ ุญุงูุฉ ุงูุฑุญูุฉ ุฅูู `completed`

**ุงูููุฏ ูู `server.js`:**
```javascript
// ุนูุฏ ุฅููุงู ุฑุญูุฉ
await pool.query(`
    INSERT INTO driver_earnings (driver_id, date, today_trips, today_earnings, total_trips, total_earnings)
    VALUES ($1, CURRENT_DATE, 1, $2, $3, $4)
    ON CONFLICT (driver_id, date) 
    DO UPDATE SET
        today_trips = driver_earnings.today_trips + 1,
        today_earnings = driver_earnings.today_earnings + $2,
        total_trips = $3,
        total_earnings = $4,
        updated_at = CURRENT_TIMESTAMP
`, [driverId, cost, newTotalTrips, newTotalEarnings]);
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ ุดุงูู ูููุธุงู
ุงุณุชุฎุฏู ุงูุณูุฑูุจุช ุงูุชุงูู ููุชุญูู ูู ุนูู ุงููุธุงู:

```bash
node test-earnings-system.js
```

**ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ูุชู ุฅุฌุฑุงุคูุง:**
1. โ ุงูุชุญูู ูู ุจููุฉ ุฌุฏูู `drivers`
2. โ ุงูุชุญูู ูู ุจููุฉ ุฌุฏูู `driver_earnings`
3. โ ุงูุชุญูู ูู ูุฌูุฏ ุจูุงูุงุช ุงูุณุงุฆููู
4. โ ุงูุชุญูู ูู ุณุฌูุงุช ุงูุฃุฑุจุงุญ
5. โ ูุญุงูุงุฉ API endpoints

---

## ๐ ูุซุงู ุนูู ุงูุจูุงูุงุช

### ุจูุงูุงุช ุณุงุฆู ูู ุฌุฏูู `drivers`:
```
ID: 1
ุงูุงุณู: ุฃุญูุฏ ูุญูุฏ
ุฃุฑุจุงุญ ุงูููู: 250.50 ุฑ.ุณ
ุฑุญูุงุช ุงูููู: 12
ุฅุฌูุงูู ุงูุฃุฑุจุงุญ: 15430.75 ุฑ.ุณ
ุฅุฌูุงูู ุงูุฑุญูุงุช: 543
ุงูุฑุตูุฏ: 15430.75 ุฑ.ุณ
```

### ุณุฌู ูููู ูู ุฌุฏูู `driver_earnings`:
```
driver_id: 1
date: 2026-02-09
today_trips: 12
today_earnings: 250.50
total_trips: 543
total_earnings: 15430.75
```

---

## ๐ ุงูุฃูุงู

- โ ุฌููุน ุงูุงุณุชุนูุงูุงุช ุชุณุชุฎุฏู Parameterized Queries ูููุน SQL Injection
- โ ุงูุชุญูู ูู ุตุญุฉ driver_id ูุจู ุงูุงุณุชุนูุงู
- โ ุงุณุชุฎุฏุงู Foreign Keys ููุญูุงุธ ุนูู ุณูุงูุฉ ุงูุจูุงูุงุช
- โ UNIQUE constraint ูููุน ุงูุชูุฑุงุฑ

---

## ๐ ุงูููุงุญุธุงุช ุงููููุฉ

1. **ุงูุชุญุฏูุซ ุงููููู**: ูุชู ุฅูุดุงุก ุณุฌู ุฌุฏูุฏ ูู `driver_earnings` ููู ููู
2. **ุงูุญูุงุธ ุนูู ุงูุจูุงูุงุช**: ุนูุฏ ุญุฐู ุณุงุฆูุ ูุชู ุญุฐู ุณุฌูุงุชู ุชููุงุฆูุงู (CASCADE)
3. **ุงูุฃุฏุงุก**: ุชู ุฅูุดุงุก Index ุนูู `(driver_id, date)` ูุชุณุฑูุน ุงูุงุณุชุนูุงูุงุช
4. **ุงูุชูุงูู**: ุงููุธุงู ูุนูู ูุน PostgreSQL

---

## ๐ ุงูุจุฏุก ุงูุณุฑูุน

```bash
# 1. ุชุดุบูู ุงูุฎุงุฏู
node server.js

# 2. ูุชุญ ุตูุญุฉ ุงูุฃุฑุจุงุญ
ุงูุชุญ ุงููุชุตูุญ ุนูู: http://localhost:3000/earnings.html

# 3. ุชุณุฌูู ุงูุฏุฎูู ูุณุงุฆู
ุณูุชู ุชุญููู ุงูุจูุงูุงุช ุชููุงุฆูุงู
```

---

## ๐ ุงูุฏุนู

ูู ุญุงูุฉ ูุฌูุฏ ุฃู ูุดุงูู:
1. ุชุญูู ูู ุงุชุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. ุชุฃูุฏ ูู ูุฌูุฏ ุงูุณุงุฆู ูู ุฌุฏูู `drivers`
3. ุดุบู ุงูุงุฎุชุจุงุฑุงุช: `node test-earnings-system.js`
4. ุฑุงุฌุน console ููุฃุฎุทุงุก

---

**ุชู ุงูุชูููุฐ ุจุชุงุฑูุฎ:** 9 ูุจุฑุงูุฑ 2026  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุฅูุชุงุฌ  
**ุงููุณุฎุฉ:** 1.0.0
